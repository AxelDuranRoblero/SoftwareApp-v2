{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Calificaci√≥n Tributaria{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/calificacion.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <aside class="sidebar">
        <div class="profile">
            <div class="profile-img">üë®</div>
            <h3>{{ user.username|default:"Benjamin Rojas" }}</h3>
            <button class="btn-profile">Perfil</button>
        </div>
        <ul class="menu">
            <li><a href="{% url 'inicio' %}">üè† Principal</a></li>
            <li class="active">üìã Crear Calificacion</li>
            <li>üìä Carga de Datos</li>
            <li>üìà Reportes</li>
        </ul>
    </aside>

    <main class="main-content">
        <header class="header">
            <div class="greeting">
                <h1>Crear Calificaci√≥n Tributaria</h1>
                <p class="subtitle">Mantenedor de Calificaciones NUAM</p>
            </div>
            <div class="header-actions">
                {% if user.is_authenticated %}
                    <a href="{% url 'logout' %}" class="btn-logout">Cerrar Sesi√≥n</a>
                {% endif %}
            </div>
        </header>

        <div class="form-container">
            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <form method="post" class="calificacion-form">
                {% csrf_token %}
                
                <div class="form-grid">
                    <!-- Informaci√≥n del Emisor -->
                    <div class="form-section">
                        <h3>üè¢ Informaci√≥n del Emisor</h3>
                        
                        <div class="form-group">
                            <label for="emisor">Nombre del Emisor *</label>
                            <input type="text" id="emisor" name="emisor" required 
                                   placeholder="Ej: Banco Estado, Falabella">
                        </div>

                        <div class="form-group">
                            <label for="rut_emisor">RUT Emisor *</label>
                            <input type="text" id="rut_emisor" name="rut_emisor" required
                                   placeholder="12.345.678-9">
                        </div>

                        <div class="form-group">
                            <label for="pais">Pa√≠s *</label>
                            <select id="pais" name="pais" required>
                                <option value="">Seleccione un pa√≠s</option>
                                <option value="chile">Chile</option>
                                <option value="colombia">Colombia</option>
                                <option value="peru">Per√∫</option>
                            </select>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Instrumento -->
                    <div class="form-section">
                        <h3>üìä Informaci√≥n del Instrumento</h3>
                        
                        <div class="form-group">
                            <label for="tipo_instrumento">Tipo de Instrumento *</label>
                            <select id="tipo_instrumento" name="tipo_instrumento" required>
                                <option value="">Seleccione tipo</option>
                                <option value="accion">Acci√≥n</option>
                                <option value="bono">Bono</option>
                                <option value="derivado">Derivado</option>
                                <option value="fondo_mutuo">Fondo Mutuo</option>
                                <option value="etf">ETF</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="nemotecnico">Nemot√©cnico *</label>
                            <input type="text" id="nemotecnico" name="nemotecnico" required
                                   placeholder="Ej: BECH, FALABELLA">
                        </div>

                        <div class="form-group">
                            <label for="estado_inscripcion">Estado de Inscripci√≥n *</label>
                            <select id="estado_inscripcion" name="estado_inscripcion" required>
                                <option value="">Seleccione estado</option>
                                <option value="inscrito">Inscrito</option>
                                <option value="no_inscrito">No Inscrito</option>
                            </select>
                        </div>
                    </div>

                    <!-- Informaci√≥n Tributaria -->
                    <div class="form-section full-width">
                        <h3>üí∞ Informaci√≥n Tributaria</h3>
                        
                        <div class="calificacion-input-group">
                            <div class="form-group">
                                <label for="tipo_declaracion">Tipo de Declaraci√≥n *</label>
                                <select id="tipo_declaracion" name="tipo_declaracion" required>
                                    <option value="">Seleccione</option>
                                    <option value="dj1948">DJ1948 - Dividendos</option>
                                    <option value="dj1847">DJ1847 - Intereses</option>
                                    <option value="certificado">Certificado Emisor</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="ano_tributario">A√±o Tributario *</label>
                                <input type="number" id="ano_tributario" name="ano_tributario" 
                                       min="2020" max="2030" required placeholder="2025">
                            </div>

                            <div class="form-group">
                                <label for="periodo">Per√≠odo *</label>
                                <select id="periodo" name="periodo" required>
                                    <option value="">Seleccione</option>
                                    <option value="anual">Anual</option>
                                    <option value="semestral">Semestral</option>
                                    <option value="trimestral">Trimestral</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Montos y Factores -->
                    <div class="form-section full-width">
                        <h3>üìà Montos y Factores Tributarios</h3>
                        
                        <div class="calificacion-input-group">
                            <div class="form-group">
                                <label for="monto_distribuido">Monto Distribuido ($) *</label>
                                <input type="number" id="monto_distribuido" name="monto_distribuido" 
                                       step="0.01" required placeholder="1000000.00">
                            </div>

                            <div class="form-group">
                                <label for="factor_actualizacion">Factor de Actualizaci√≥n</label>
                                <input type="number" id="factor_actualizacion" name="factor_actualizacion" 
                                       step="0.0001" placeholder="1.0234">
                            </div>

                            <div class="form-group">
                                <label for="credito_fiscal">Cr√©dito Fiscal (%)</label>
                                <input type="number" id="credito_fiscal" name="credito_fiscal" 
                                       step="0.01" min="0" max="100" placeholder="35.00">
                            </div>

                            <div class="form-group">
                                <label for="tasa_retencion">Tasa de Retenci√≥n (%)</label>
                                <input type="number" id="tasa_retencion" name="tasa_retencion" 
                                       step="0.01" min="0" max="100" placeholder="10.00">
                            </div>
                        </div>
                        
                        <div class="calificacion-input-group" style="margin-top: 20px;">
                            <div class="form-group">
                                <label for="monto_actualizado">Monto Actualizado ($)</label>
                                <input type="number" id="monto_actualizado" name="monto_actualizado" 
                                       step="0.01" readonly placeholder="Se calcula autom√°ticamente">
                            </div>

                            <div class="form-group">
                                <label for="impuesto_calculado">Impuesto Calculado ($)</label>
                                <input type="number" id="impuesto_calculado" name="impuesto_calculado" 
                                       step="0.01" readonly placeholder="Se calcula autom√°ticamente">
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Corredor -->
                    <div class="form-section">
                        <h3>üë§ Informaci√≥n del Corredor</h3>
                        
                        <div class="form-group">
                            <label for="corredor">Corredor de Bolsa *</label>
                            <input type="text" id="corredor" name="corredor" required
                                   placeholder="Nombre del corredor">
                        </div>

                        <div class="form-group">
                            <label for="fecha_registro">Fecha de Registro *</label>
                            <input type="date" id="fecha_registro" name="fecha_registro" required>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="form-section">
                        <h3>üìù Observaciones</h3>
                        
                        <div class="form-group">
                            <label for="observaciones">Comentarios Adicionales</label>
                            <textarea id="observaciones" name="observaciones" rows="4" 
                                      placeholder="Ingrese observaciones sobre la calificaci√≥n tributaria..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-calculate" onclick="calcularMontos()">
                        üßÆ Calcular Montos
                    </button>
                    <button type="submit" class="btn-submit">
                        üíæ Guardar Calificaci√≥n
                    </button>
                    <a href="{% url 'inicio' %}" class="btn-cancel">
                        ‚ùå Cancelar
                    </a>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    // Calcular montos autom√°ticamente
    function calcularMontos() {
        const montoDistribuido = parseFloat(document.getElementById('monto_distribuido').value) || 0;
        const factorActualizacion = parseFloat(document.getElementById('factor_actualizacion').value) || 1;
        const tasaRetencion = parseFloat(document.getElementById('tasa_retencion').value) || 0;
        
        if (montoDistribuido > 0) {
            // Calcular monto actualizado
            const montoActualizado = montoDistribuido * factorActualizacion;
            document.getElementById('monto_actualizado').value = montoActualizado.toFixed(2);
            
            // Calcular impuesto
            const impuesto = montoActualizado * (tasaRetencion / 100);
            document.getElementById('impuesto_calculado').value = impuesto.toFixed(2);
            
            // Mostrar mensaje de √©xito
            alert('‚úÖ C√°lculos realizados correctamente');
        } else {
            alert('‚ö†Ô∏è Debe ingresar el monto distribuido primero');
        }
    }

    // Formatear RUT chileno
    const rutInputs = document.querySelectorAll('[id$="_emisor"]');
    rutInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let valor = e.target.value.replace(/[^0-9kK]/g, '');
            if (valor.length > 1) {
                const dv = valor.slice(-1);
                const numero = valor.slice(0, -1);
                valor = numero.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + dv;
            }
            e.target.value = valor;
        });
    });

    // Establecer fecha actual por defecto
    const fechaInput = document.getElementById('fecha_registro');
    const today = new Date().toISOString().split('T')[0];
    fechaInput.value = today;

    // Validaci√≥n antes de enviar
    document.querySelector('.calificacion-form').addEventListener('submit', function(e) {
        const montoDistribuido = document.getElementById('monto_distribuido').value;
        if (!montoDistribuido || montoDistribuido <= 0) {
            e.preventDefault();
            alert('‚ö†Ô∏è Debe ingresar un monto distribuido v√°lido');
            return false;
        }
    });

    // Formatear n√∫meros con separador de miles
    const montoInputs = document.querySelectorAll('input[type="number"][id^="monto"]');
    montoInputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (this.value) {
                const valor = parseFloat(this.value);
                this.value = valor.toFixed(2);
            }
        });
    });
</script>
{% endblock %}